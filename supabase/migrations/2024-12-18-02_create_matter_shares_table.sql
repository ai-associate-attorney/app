CREATE TABLE matter_shares (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    matter_id bigint REFERENCES matters(id) ON DELETE CASCADE,
    shared_with_user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
    access_type varchar NOT NULL CHECK (access_type IN ('view', 'edit')),
    created_by uuid REFERENCES auth.users(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    UNIQUE(matter_id, shared_with_user_id)
);

-- Create indexes
CREATE INDEX matter_shares_matter_id_idx ON matter_shares(matter_id);
CREATE INDEX matter_shares_shared_with_user_id_idx ON matter_shares(shared_with_user_id);
CREATE INDEX matter_shares_created_by_idx ON matter_shares(created_by);

-- Enable RLS
ALTER TABLE matter_shares ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view shares for their matters"
    ON matter_shares FOR SELECT
    USING (
        matter_id IN (
            SELECT id FROM matters WHERE created_by = auth.uid()
        )
        OR
        shared_with_user_id = auth.uid()
    );

CREATE POLICY "Matter owners can manage shares"
    ON matter_shares FOR ALL
    USING (
        matter_id IN (
            SELECT id FROM matters WHERE created_by = auth.uid()
        )
    ); 